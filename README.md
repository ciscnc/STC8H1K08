# GL08 双通道控制板固件

## 项目简介

GL08双通道控制板是一个基于STC8H1K08-36I-TSSOP20微控制器的智能调光控制系统，支持双通道独立调光控制，适用于植物补光灯等应用场景。

## 主要功能

- **双通道独立调光**：支持2路独立的0-10V/PWM信号输出
- **多种控制方式**：
  - 旋钮调光控制
  - RJ12网口调光控制
  - RJ12网口级联控制
- **波段开关控制**：6档波段开关（EXT、0%、25%、50%、75%、100%）
- **拨动开关功率限制**：3档功率限制（66.7%、83.3%、100%）
- **级联控制**：支持无限级联扩展

## 硬件规格

- **MCU**: STC8H1K08-36I-TSSOP20
- **输入电压**: 12VDC
- **输入功率**: <2W
- **输入信号**: 0-10V信号，匹配2路控制器面板
- **输出信号**: 2路独立0-10V/PWM信号
- **通信接口**: RJ12网口（DATA IN/DATA OUT）

## 项目结构

```
├── Drivers/                  # 硬件驱动层
│   ├── bsp_system.c/h       # 系统初始化
│   ├── bsp_gpio.c/h        # GPIO驱动
│   ├── bsp_adc.c/h         # ADC驱动
│   ├── bsp_pwm.c/h         # PWM驱动（输入捕获+输出比较）
│   ├── bsp_timer.c/h       # 定时器驱动
│   ├── bsp_uart.c/h        # UART驱动
│   ├── bsp_led.c/h        # LED驱动
│   └── bsp_delay.c/h      # 延时驱动
├── User/                    # 业务逻辑层
│   ├── main.c              # 主程序入口
│   ├── gl08_hardware.c/h   # 硬件抽象层统一引用
│   ├── gl08_control.c/h    # 控制逻辑
│   ├── gl08_switch.c/h     # 波段开关处理
│   ├── gl08_config.h       # 配置文件
│   ├── task.c/h           # 任务调度器
│   ├── filter.c/h         # 滤波算法
│   ├── baremetal_sem.c/h   # 二值信号量
│   ├── isp_trigger.c/h     # ISP触发机制
│   └── type_def.h        # 类型定义
├── MDK/                    # Keil工程文件
└── README.md              # 项目文档
```

## 开发环境

### 支持的编译器

1. **Keil C51** (推荐用于STC8系列开发)
2. **SDCC** (开源8051编译器)

### 构建系统

项目使用Keil MDK作为主要开发环境，支持直接编译和调试。

## 快速开始

### 1. 环境准备

确保已安装以下工具：
- Keil C51（推荐）
- STC-ISP（用于烧录）

### 2. 构建项目

#### 使用Keil开发

```
1. 打开 MDK/plantgrowlight.uvprojx
2. 选择目标 'GL08'
3. 点击 Build (F7) 编译
4. 编译成功后生成 Objects/plantgrowlight.hex
```

### 3. 烧录固件

使用 STC-ISP 工具烧录：
1. 打开 STC-ISP
2. 选择正确的MCU型号: STC8H1K08-36I-TSSOP20
3. 打开编译生成的 hex 文件
4. 连接 USB 转 UART 下载器
5. 点击"下载/编程"按钮

## 功能说明

### 波段开关控制

| 档位 | 功能 | 输出比例 |
|------|------|----------|
| EXT  | 外接面板控制 | 需要外部信号 |
| 1档  | 固定输出 | 0% |
| 2档  | 固定输出 | 25% |
| 3档  | 固定输出 | 50% |
| 4档  | 固定输出 | 75% |
| 5档  | 固定输出 | 100% |

### 拨动开关功率限制

| 档位 | 功率限制 | 输出范围 |
|------|----------|----------|
| 66.7% | 限制最大功率 | 2-6.67V |
| 83.3% | 限制最大功率 | 2-8.3V |
| 100%  | 无限制 | 2-10V |

## 系统架构

### 中断优先级配置

| 外设 | 优先级 | 说明 |
|------|--------|------|
| ADC | 3 (最高) | 保证采样数据实时性 |
| PWM | 2 (次高) | 保证输入捕获及时性 |
| Timer | 1 | 系统滴答和任务调度 |
| UART | 0 (最低) | 调试打印，不干扰关键功能 |

### 数据存储优化

系统使用 `data` 关键字将频繁访问的变量放置在128字节内部直接访问RAM中，提高访问速度：
- 控制状态变量（control_state）
- 滤波器状态变量（pwm_filters, pwm_dc_filter）
- ADC采样数据（adc_raw_values）
- PWM捕获数据（pwm_capture_data）

### 通信协议

#### RJ12接口

- **DATA IN**: 接收级联控制信号
- **DATA OUT**: 发送级联控制信号

#### 级联控制

支持通过RJ12接口进行级联控制，实现多设备协调工作。

### 控制算法

#### PWM输入捕获
- 使用 PWMA 的 CC1/CC2/CC3/CC4 通道进行输入捕获
- 捕获上升沿和下降沿，计算占空比
- 支持1KHz PWM信号输入
- 超时检测：连续2个控制周期未捕获，进入直流电平检测

#### 直流电平检测
- 当PWM捕获超时，检测输入电平
- 连续3次采样确认为高电平 → 100%输出
- 连续3次采样确认为低电平 → 0%输出

#### 滤波算法
- 采用单次指数平滑滤波（EWMA）
- 死区：偏差≤10不滤波
- 限幅：偏差>100丢弃
- 滤波长度N=4

#### 端点锁定
- 占空比≤10，锁定为0%
- 占空比≥990，锁定为100%
- 防止端点抖动

## 开发指南

### 代码结构

- **Drivers/**: 硬件驱动层，实现GPIO、ADC、PWM、Timer、UART等底层操作
- **User/**: 业务逻辑层，实现控制逻辑、任务调度、滤波算法等
  - `main.c`: 主程序入口，系统初始化和主循环
  - `gl08_hardware.c/h`: 硬件抽象层，统一引用各驱动模块
  - `gl08_control.c/h`: 控制逻辑，处理调光算法和开关状态
  - `gl08_switch.c/h`: 波段开关处理逻辑
  - `task.c/h`: 任务调度器
  - `filter.c/h`: 滤波算法
  - `baremetal_sem.c/h`: 二值信号量实现
  - `isp_trigger.c/h`: ISP密码触发机制

### 配置选项

在 `User/gl08_config.h` 中可以配置：
- 系统参数（时钟频率、波特率）
- 硬件引脚定义
- 通信参数
- 调光参数
- PWM和ADC相关宏定义

### 中断服务函数

- `adc_Isr()`: ADC转换完成中断
- `PWM1_CCR1_ISR`: PWM1输入捕获中断
- `PWM1_CCR2_ISR`: PWM1输入捕获中断
- `PWM1_CCR3_ISR`: PWM2输入捕获中断
- `PWM1_CCR4_ISR`: PWM2输入捕获中断
- `Timer0_ISR`: 系统滴答中断

## 构建状态

- ✅ Keil C51编译支持
- ✅ SDCC编译支持（兼容性验证）
- ✅ 中断优先级配置
- ✅ 数据存储优化
- ✅ ISP触发机制
- ✅ 双通道独立控制

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 贡献

欢迎提交Issue和Pull Request来改进项目。

## 联系方式

- 作者: Lighting Control Software Team
- 项目地址: ssh://git@10.255.5.150:1022/liquanhai/plantgrowlight.git
